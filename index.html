    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>Multi-Cloud JSON Explorer</title>
      <style>

        .control-nav-group {
          margin: 8px 0;
        }
        
        .control-nav-header {
          font-weight: 600;
          margin: 6px 0;
          cursor: pointer;
          color: #93c5fd;
          padding: 6px 8px;
          border-radius: 4px;
          background: #1e293b;
          transition: background 0.2s;
        }
        .control-nav-header:hover {
          background: #334155;
        }
        
        .control-nav-list {
          margin-left: 10px;
          margin-top: 4px;
        }
        
        .control-nav-card {
          background: #334155;
          padding: 8px;
          margin: 4px 0;
          border-radius: 4px;
          cursor: pointer;
          transition: background 0.2s, transform 0.2s;
          color: #f8fafc;
          font-size: 14px;
        }
        .control-nav-card:hover {
          background: #475569;
          transform: translateX(4px);
        }
        
        body, html {
          height: 100%;
          overflow: hidden;  /* prevent body scrolling */
        }
        
        main {
          flex: 1;
          display: flex;
          min-height: 0;  /* important for flexbox children */
        }
        
        #nav {
          width: 260px;
          background: #1e293b;
          color: #e2e8f0;
          padding: 12px;
          overflow-y: auto;   /* independent scroll */
          border-right: 1px solid #334155;
        }
        
        #center {
          flex: 1;
          display: flex;
          flex-direction: column;
          background: #f9fafb;
          overflow: hidden;   /* contain its children */
        }
        
        #explorer {
          flex: 1;
          padding: 20px;
          overflow-y: auto;   /* explorer scrolls */
        }
        
        #details {
          border-top: 1px solid #ddd;
          padding: 20px;
          background: #f3f4f6;
          overflow-y: auto;
          max-height: 40%;    /* CLI/details area stays contained */
        }

        /* --- control nav cards --- */
        .control-nav-group {
          margin: 12px 0;
        }
        
        .control-nav-header {
          font-weight: 600;
          margin: 6px 0;
          cursor: pointer;
          color: #93c5fd;
        }
        
        .control-nav-card {
          background: #334155;
          padding: 10px;
          margin: 6px 0;
          border-radius: 6px;
          cursor: pointer;
          transition: background 0.2s, transform 0.2s;
          color: #f8fafc;
          font-size: 14px;
        }
        .control-nav-card:hover {
          background: #475569;
          transform: translateX(4px);
        }

        .command-card {
          background: #f8fafc;
          padding: 12px;
          margin: 8px 0;
          border-radius: 6px;
          cursor: pointer;
          transition: background 0.2s;
        }
        .command-card:hover {
          background: #e2e8f0;
        }
      
        /* --- layout --- */
        body {
          margin: 0;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
          display: flex;
          flex-direction: column;
          height: 100vh;
          background: #f9fafb;
        }
        header {
          background: #2563eb;
          color: #fff;
          padding: 10px 20px;
          display: flex;
          align-items: center;
          font-weight: 600;
        }
        main { flex: 1; display: flex; }
        #nav {
          width: 220px;
          background: #1e293b;
          color: #e2e8f0;
          padding: 12px;
          overflow-y: auto;
          border-right: 1px solid #334155;
        }
        #center {
          flex: 1;
          display: flex;
          flex-direction: column;
          background: #f9fafb;
        }
        #top-bar {
          padding: 12px 20px;
          border-bottom: 1px solid #ddd;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        #top-bar input {
          padding: 6px;
          border-radius: 4px;
          border: 1px solid #ccc;
          width: 240px;
        }
        #explorer {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
        }
        #details {
          border-top: 1px solid #ddd;
          padding: 20px;
          background: #f3f4f6;
          display: none;
        }

        /* --- breadcrumbs --- */
        #breadcrumb { font-size: 16px; }
        #breadcrumb span {
          cursor: pointer;
          color: #2563eb;
          font-weight: 500;
          margin-right: 6px;
        }
        #breadcrumb span:hover { text-decoration: underline; }
        #breadcrumb .current {
          color: #111827;
          font-weight: 600;
          cursor: default;
          text-decoration: none;
        }
        #breadcrumb .sep { margin: 0 4px; color: #6b7280; }

        /* --- providers --- */
        .provider-card {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px;
          margin: 10px 0;
          border-radius: 8px;
          cursor: pointer;
          color: #fff;
          font-weight: 500;
          transition: .25s all;
        }
        .provider-card:hover {
          transform: translateX(4px);
          box-shadow: 0 4px 12px rgba(0,0,0,.25);
        }
        .provider-card.azure { background: #0078D4; }
        .provider-card.aws { background: #FF9900; }
        .provider-card.oci { background: #C74634; }
        .provider-card.gcloud { background: #4285F4; }
        .provider-card.aliyun { background: #FF6A00; }
        .provider-card.ibmcloud { background: #1261FE; }
        .provider-card.ovhai { background: #123F6D; }
        .provider-card.torlite { background: #6D28D9; }

        /* --- explorer cards --- */
        .drill-card {
          padding: 14px;
          margin: 10px 0;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          cursor: pointer;
          transition: .2s all;
        }
        .drill-card:hover {
          background: #f1f5f9;
          transform: translateY(-2px);
        }
        .drill-card .meta { font-size: 12px; opacity: .7; }
        .drill-card.leaf { border-left: 4px solid #2563eb; }
        .drill-card.group { border-left: 4px solid #94a3b8; }

        /* --- forms --- */
        .form-field { margin: 8px 0; }
        .form-field label { font-size: 14px; font-weight: 500; }
        .form-field input {
          font-size: 14px;
          font-family: "JetBrains Mono", monospace;
        }

        /* --- code blocks --- */
        pre, #json-display, #cli-display {
          font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", monospace;
          font-size: 14px;
          background: #111827;
          color: #e5e7eb;
          padding: 14px;
          border-radius: 6px;
          line-height: 1.45;
          max-height: 300px;
          overflow: auto;
        }

        /* --- buttons --- */
        button {
          margin: 6px 4px 0 0;
          padding: 8px 14px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          background: #2563eb;
          color: #fff;
          font-size: 14px;
          transition: .2s background;
        }
        button:hover { background: #1d4ed8; }

        /* --- toasts --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
          min-width: 200px;
          margin-bottom: 10px;
          padding: 12px 16px;
          border-radius: 6px;
          color: #fff;
          font-size: 14px;
          opacity: 0;
          transform: translateY(-10px);
          animation: fadeInOut 4s forwards;
        }
        .toast.info { background: #2563eb; }
        .toast.success { background: #16a34a; }
        .toast.warning { background: #f59e0b; }
        .toast.error { background: #dc2626; }
        @keyframes fadeInOut {
          0% { opacity: 0; transform: translateY(-10px); }
          10% { opacity: 1; transform: translateY(0); }
          90% { opacity: 1; transform: translateY(0); }
          100% { opacity: 0; transform: translateY(-10px); }
        }

        /* --- matched controls panel --- */
        #matches-panel h3 {
          margin: 0 0 10px 0;
          font-size: 16px;
        }
        .controls-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
          gap: 12px;
        }

        /* --- flip card for controls --- */
        .control-card {
          perspective: 1000px;
          width: 320px;
          margin: 12px;
        }
        
        .control-card-inner {
          position: relative;
          width: 100%;
          min-height: 180px;
          transform-style: preserve-3d;
          transition: transform 0.6s;
        }
        
        .control-card.flipped .control-card-inner {
          transform: rotateY(180deg);
        }
        
        .control-card-front, .control-card-back {
          position: absolute;
          width: 100%;
          backface-visibility: hidden;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          padding: 16px;
          background: white;
        }
        
        .control-card-back {
          transform: rotateY(180deg);
          white-space: normal;
          max-height: 250px;
          overflow: hidden;
        }
        
        .control-card-back:hover {
          overflow-y: auto;    /* scroll only when hovered */
        }
        
      </style>
    </head>
    <body>
      <header>Multi-Cloud JSON Explorer</header>
      <main>
        <nav id="nav"></nav>
        <div id="center">
          <div id="top-bar">
            <div id="breadcrumb"></div>
            <div style="display:flex;align-items:center;gap:12px;">
              <input type="text" id="search" placeholder="Search..." />
              <button id="mode-toggle">Switch to Control Mode</button>
            </div>
          </div>
          <div id="explorer"><p>Select a provider to explore.</p></div>
          <section id="details">
            <h2 id="op-title">Operation</h2>
            <p><em id="op-help"></em></p>
            <div id="provider-tools" style="margin-bottom:10px;">
              <button onclick="downloadProviderJSON()">Download Provider JSON</button>
            </div>
            <div id="form-container"></div>
            <pre id="json-display">No JSON loaded yet...</pre>
            <pre id="cli-display">No CLI generated yet...</pre>
            <div>
              <button onclick="copyJSON()">Copy JSON</button>
              <button onclick="downloadJSON()">Download JSON</button>
              <button onclick="copyCLI()">Copy CLI</button>
            </div>
          </section>
        </div>
      </main>

      <script src="https://unpkg.com/lucide@latest"></script>
      <script>
        /* --------------------------- globals / state --------------------------- */
        let mode = "provider";                // "provider" | "control"
        let providerCommandIndex = null;      // flattened commands across providers
        let controlToCommands = {};           // { "AC-1": { meta, commands: [...] }, ... }

        // Use GitHub Release asset for control mappings
        const controlToCommandsUrl = "https://github.com/stacksc/cloud-explorer/releases/latest/download/command_to_controls.json";
        
        // Load the big mapping file
        async function loadControlMappings() {
          try {
            const resp = await fetch(controlToCommandsUrl);
            if (!resp.ok) throw new Error("Failed to load control mappings");
            controlToCommands = await resp.json();
            console.log("âœ… Loaded control mappings:", controlToCommands);
          } catch (err) {
            console.error("âŒ Could not load control mappings:", err);
            controlToCommands = {};
          }
        }
        
        // call this during startup
        loadControlMappings();
      
        let iconMap = {};
        fetch("icon_map.json").then(r=>r.json()).then(d=>iconMap=d).catch(()=>{});
      
        const providers = [
          { name:"Azure",        file:"providers/az.json",      key:"az",      bin:"az" },
          { name:"AWS",          file:"providers/aws.json",     key:"aws",     bin:"aws" },
          { name:"OCI",          file:"providers/oci.json",     key:"oci",     bin:"oci" },
          { name:"Google Cloud", file:"providers/gcloud.json",  key:"gcloud",  bin:"gcloud" },
          { name:"Alibaba Cloud",file:"providers/aliyun.json",  key:"aliyun",  bin:"aliyun" },
          { name:"IBM Cloud",    file:"providers/ibmcloud.json",key:"ibmcloud",bin:"ibmcloud" },
          { name:"OVHcloud AI",  file:"providers/ovhai.json",   key:"ovhai",   bin:"ovhai" },
          { name:"TorLite",      file:"providers/torlite.json", key:"torlite", bin:"torlite" },
        ];


        async function maybeAddAzureDiscovery() {
          try {
            const resp = await fetch("providers/azure_discovery.json?ts=" + Date.now());
            if (resp.ok) {
              providers.push({
                key: "azure-discovery",
                name: "Azure Discovery Snapshot",
                file: "providers/azure_discovery.json?ts=" + Date.now()
              });
              console.log("âœ… Azure discovery enabled");
            } else {
              console.log("â„¹ï¸ No Azure discovery data found, skipping.");
            }
          } catch (err) {
            console.log("â„¹ï¸ Azure discovery not available, skipping.");
          }
        }
        
        let commandToControls = null;
        async function loadControlsMapping(){
          if(!commandToControls){
            try {
              const resp = await fetch("command_to_controls.json");
              commandToControls = await resp.json();
            } catch(err){ console.error("Failed to load mapping", err); }
          }
        }
      
        /* ----------------------------- debounce ------------------------------- */
        function debounce(fn, delay = 250) {
          let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
        }
      
        /* -------------------------- provider indexing ------------------------- */
        function flattenCommands(root, prefix = []) {
          const out = [];
          const sub = root?.subcommands || {};
          for (const [key, node] of Object.entries(sub)) {
            const path = [...prefix, key];
            const fullCmd = path.join(" ");
            out.push({ fullCmd, help: node.help || "", name: key });
            if (node.subcommands && Object.keys(node.subcommands).length) {
              out.push(...flattenCommands(node, path));
            }
          }
          return out;
        }
      
        async function buildProviderIndex() {
          if (providerCommandIndex) return providerCommandIndex;
          providerCommandIndex = [];
          for (const p of providers) {
            try {
              const resp = await fetch(p.file);
              if (!resp.ok) continue;
              const tree = await resp.json();
              const root = tree[p.key] || tree.subcommands || tree;
              const flat = flattenCommands(root);
              flat.forEach(item => {
                providerCommandIndex.push({
                  provider: p.key,
                  fullCmd: item.fullCmd,
                  help: item.help,
                  name: item.name,
                });
              });
            } catch (_) { /* ignore per provider */ }
          }
          return providerCommandIndex;
        }
      
        /* -------------------------- controls reverse idx ---------------------- */
        async function buildReverseIndex() {
          await loadControlsMapping();
          controlToCommands = {};
          if (!commandToControls) return;
      
          for (const [cmdKey, entry] of Object.entries(commandToControls)) {
            if (!entry.matched_controls || !entry.matched_controls.length) continue;
      
            const [prov, fullCmd] = cmdKey.split(":");
            const help = entry.help || "";
      
            for (const ctrl of entry.matched_controls) {
              if (!controlToCommands[ctrl.id]) {
                controlToCommands[ctrl.id] = { meta: ctrl, commands: [] };
              }
              controlToCommands[ctrl.id].commands.push({ provider: prov, fullCmd, help });
            }
          }
        }
      
        /* ------------------------------- search -------------------------------- */
        async function searchProviders(query) {
          await buildProviderIndex();
      
          const center = document.getElementById("explorer");
          center.innerHTML = "<h3>Search Results</h3>";
      
          const q = query.toLowerCase();
          const matches = providerCommandIndex.filter(item =>
            item.name.toLowerCase().includes(q) ||
            item.fullCmd.toLowerCase().includes(q) ||
            item.help.toLowerCase().includes(q) ||
            item.provider.toLowerCase().includes(q)
          ).slice(0, 200);
      
          if (matches.length === 0) {
            center.innerHTML += "<p>No matches found.</p>";
            return;
          }
      
          matches.forEach(match => {
            const card = document.createElement("div");
            card.className = "command-card";
            card.innerHTML = `
              <strong>${match.provider}</strong> â€º ${match.fullCmd}<br>
              <small>${match.help || ""}</small>
            `;
            card.onclick = () => {
              const provObj = providers.find(p => p.key === match.provider);
              if (provObj) loadProvider(provObj).then(() => navigateTo(match.fullCmd.split(" ")));
            };
            center.appendChild(card);
          });
        }
      
        function searchControls(query) {
          const nav = document.getElementById("nav");
          nav.innerHTML = "<h3>Controls</h3>";
      
          const q = query.toLowerCase();
          const isFamilyHint = q.length <= 3;
      
          const allIds = Object.keys(controlToCommands);
          let matches = allIds.filter(id => {
            const meta = controlToCommands[id].meta || {};
            const family = (meta.family || id.split("-")[0] || "").toLowerCase();
            const title = (meta.title || "").toLowerCase();
            return id.toLowerCase().includes(q) || title.includes(q) || family.includes(q);
          });
      
          if (isFamilyHint) {
            matches.sort((a, b) => {
              const fa = (controlToCommands[a].meta?.family || a.split("-")[0] || "").toLowerCase();
              const fb = (controlToCommands[b].meta?.family || b.split("-")[0] || "").toLowerCase();
              const aStarts = fa.startsWith(q) ? 0 : 1;
              const bStarts = fb.startsWith(q) ? 0 : 1;
              return aStarts - bStarts || a.localeCompare(b);
            });
          }
      
          if (matches.length === 0) {
            nav.innerHTML += "<p style='padding:10px'>No controls found.</p>";
            return;
          }
      
          // group by family
          const grouped = {};
          matches.forEach(id => {
            const fam = (controlToCommands[id].meta?.family || id.split("-")[0]).toUpperCase();
            if (!grouped[fam]) grouped[fam] = [];
            grouped[fam].push(id);
          });
      
          Object.entries(grouped).forEach(([fam, ctrls]) => {
            const famContainer = document.createElement("div");
            famContainer.className = "control-nav-group";
      
            const header = document.createElement("div");
            header.className = "control-nav-header";
            header.textContent = fam;
            famContainer.appendChild(header);
      
            const list = document.createElement("div");
            list.className = "control-nav-list";
            list.style.display = "block"; // show results expanded for search
      
            ctrls.sort().forEach(ctrlId => {
              const meta = controlToCommands[ctrlId].meta || {};
              const card = document.createElement("div");
              card.className = "control-nav-card";
              card.textContent = `${ctrlId}${meta.title ? " â€“ " + meta.title : ""}`;
              card.onclick = () => renderCommandsForControl(ctrlId);
              list.appendChild(card);
            });
      
            famContainer.appendChild(list);
            nav.appendChild(famContainer);
          });
        }
      
        /* ------------------------------ toggle btn ------------------------------ */
        document.getElementById("mode-toggle").addEventListener("click", async ()=>{
          const search = document.getElementById("search");
          const explorer = document.getElementById("explorer");
          search.value = "";
          explorer.innerHTML = "<p>Select a provider or control.</p>";
      
          if(mode === "provider"){
            mode = "control";
            document.getElementById("mode-toggle").textContent = "Switch to Provider Mode";
            await buildReverseIndex();
            renderControlsNav();
          } else {
            mode = "provider";
            document.getElementById("mode-toggle").textContent = "Switch to Control Mode";
            renderProviders();
          }
        });
      
        /* ------------------------- control mode sidebar ------------------------- */
        function renderControlsNav() {
          const nav = document.getElementById("nav");
          nav.innerHTML = "<h3>Controls</h3>";
      
          const grouped = {};
          for (const ctrlId of Object.keys(controlToCommands)) {
            const fam = ctrlId.split("-")[0].toUpperCase();
            if (!grouped[fam]) grouped[fam] = [];
            grouped[fam].push(ctrlId);
          }
      
          Object.entries(grouped).forEach(([fam, ctrls]) => {
            const famContainer = document.createElement("div");
            famContainer.className = "control-nav-group";
      
            const header = document.createElement("div");
            header.className = "control-nav-header";
            header.textContent = fam;
            famContainer.appendChild(header);
      
            const list = document.createElement("div");
            list.className = "control-nav-list";
            list.style.display = "none";
      
            ctrls.sort().forEach(ctrlId => {
              const meta = controlToCommands[ctrlId].meta || {};
              const card = document.createElement("div");
              card.className = "control-nav-card";
              card.textContent = `${ctrlId}${meta.title ? " â€“ " + meta.title : ""}`;
              card.onclick = () => renderCommandsForControl(ctrlId);
              list.appendChild(card);
            });
      
            nav.appendChild(famContainer);
            famContainer.appendChild(header);
            famContainer.appendChild(list);
      
            header.addEventListener("click", () => {
              list.style.display = list.style.display === "none" ? "block" : "none";
            });
          });
        }
      
        function renderCommandsForControl(ctrlId){
          const ex = document.getElementById("explorer");
          const meta = controlToCommands[ctrlId]?.meta || {};
          ex.innerHTML = `<h2>${ctrlId}${meta.title ? " â€“ " + meta.title : ""}</h2>`;
      
          const list = controlToCommands[ctrlId]?.commands || [];
          if (list.length === 0) {
            ex.innerHTML += `<p>No commands mapped for ${ctrlId}</p>`;
            return;
          }
      
          list.forEach(item => {
            const card = document.createElement("div");
            card.className = "drill-card leaf";
            card.style.maxWidth = "800px";
            card.innerHTML = `<h4>${item.provider}: ${item.fullCmd}</h4>
                              <p class="meta">${item.help || ""}</p>`;
            card.onclick = () => {
              const provObj = providers.find(p => p.key === item.provider);
              if (provObj) loadProvider(provObj).then(() => navigateTo(item.fullCmd.split(" ")));
            };
            ex.appendChild(card);
          });
        }
      
        /* ------------------------------ providers UI ---------------------------- */
        function renderProviders(){
          const nav=document.getElementById("nav");
          nav.innerHTML="<h3>Cloud Providers</h3>";
          providers.forEach(p=>{
            const card=document.createElement("div");
            card.className=`provider-card ${p.key}`;
            card.textContent=p.name;
            card.onclick=()=>loadProvider(p);
            nav.appendChild(card);
          });
        }
      
        let currentProvider=null,currentTree=null,rootNode=null,path=[];
        const isLeaf=n=>!n||!n.subcommands||Object.keys(n.subcommands).length===0;
        function nodeFromPath(root,arr){let n=root;for(const seg of arr){if(!n.subcommands||!n.subcommands[seg])return null;n=n.subcommands[seg];}return n;}
        function fullCmdFromPath(arr){return arr.join(" ");}
      
        async function loadProvider(provider){
          currentProvider = provider;
          path = [];
        
          try {
            const resp = await fetch(provider.file);
            if (!resp.ok) throw new Error("HTTP error " + resp.status);
            currentTree = await resp.json();
        
            if (provider.key === "azure-discovery") {
              rootNode = currentTree.subscriptions;
            } else {
              rootNode = currentTree[provider.key] || currentTree.subcommands || currentTree;
            }
        
            navigateTo([]);
          } catch (e) {
            console.error("Provider load failed", e);
            document.getElementById("explorer").innerHTML =
              `<p style="color:red">Failed to load ${provider.file}</p>`;
          }
        }

        function navigateTo(newPath) {
          path = [...newPath];
          let node = rootNode;
        
          try {
            if (currentProvider?.key === "azure-discovery") {
              if (newPath.length === 0) {
                node = rootNode; // back to subscriptions list
              } else {
                for (let i = 0; i < path.length; i++) {
                  const seg = path[i];
                  if (!node) break;   // bail if structure mismatch
                  if (i === 0) {
                    node = node[seg]; // subscription
                  } else if (i === 1) {
                    node = node.services?.[seg]; // service
                  } else if (i === 2) {
                    node = node[seg]; // resource type
                  } else if (i === 3) {
                    // resource name â†’ details handled elsewhere
                  }
                }
              }
            } else {
              node = nodeFromPath(rootNode, path);
            }
        
            renderBreadcrumb();
            renderExplorer(node);
        
            if (currentProvider?.key !== "azure-discovery") {
              if (isLeaf(node)) showDetails(node);
              else resetDetailsPanel();
            }
          } catch (err) {
            console.error("Navigation error", err, { path, node });
            document.getElementById("explorer").innerHTML =
              `<p style="color:red">Navigation error at path [${path.join(" â€º ")}]</p>`;
          }
        }
        
        function renderBreadcrumb() {
          const bc = document.getElementById("breadcrumb");
          bc.innerHTML = "";
        
          if (!currentProvider) return;
        
          // Add provider name first
          const prov = document.createElement("span");
          prov.textContent = currentProvider.name;
          prov.className = `crumb ${path.length === 0 ? "current" : ""}`;
          if (path.length > 0) prov.onclick = () => navigateTo([]);
          bc.appendChild(prov);
        
          // ---------------- Azure Discovery Breadcrumbs ----------------
          if (currentProvider.key === "azure-discovery") {
            path.forEach((seg, i) => {
              const sep = document.createElement("span");
              sep.textContent = "â€º";
              sep.className = "sep";
              bc.appendChild(sep);
          
              let label = seg;
              if (i === 0) label = rootNode[seg]?.name || seg; // subscription
              else if (i === 1) label = seg;                    // service
              else if (i === 2) label = seg;                    // resource type
              else if (i === 3) label = seg;                    // resource name
          
              const s = document.createElement("span");
              s.textContent = label;
              s.className = `crumb ${i === path.length - 1 ? "current" : ""}`;
              if (i !== path.length - 1) {
                s.onclick = () => navigateTo(path.slice(0, i + 1));
              }
              bc.appendChild(s);
            });
            return;
          }
           
          // ---------------- CLI Provider Breadcrumbs ----------------
          path.forEach((seg, i) => {
            const sep = document.createElement("span");
            sep.textContent = "â€º";
            sep.className = "sep";
            bc.appendChild(sep);
        
            const s = document.createElement("span");
            s.textContent = seg;
            s.className = `crumb ${i === path.length - 1 ? "current" : ""}`;
            if (i !== path.length - 1) s.onclick = () => navigateTo(path.slice(0, i + 1));
            bc.appendChild(s);
          });
        }
        
        async function renderExplorer(node) {
          const ex = document.getElementById("explorer");
          ex.innerHTML = "";
        
          // ---------- Azure Discovery mode ----------
          if (currentProvider?.key === "azure-discovery") {
            // path = [] â†’ show subscriptions (sorted, name + ID)
            if (path.length === 0) {
              const subs = Object.entries(rootNode || {});
              subs.sort(([idA, objA], [idB, objB]) => {
                const a = (objA?.name || idA).toLowerCase();
                const b = (objB?.name || idB).toLowerCase();
                return a.localeCompare(b);
              });
        
              subs.forEach(([subId, subObj]) => {
                const displayName = subObj?.name || subId;
                const card = document.createElement("div");
                card.className = "drill-card group";
                card.innerHTML = `
                  <h4 style="margin:0">${displayName}</h4>
                  <p class="meta" style="margin:4px 0 0 0">${subId}</p>
                `;
                card.onclick = () => navigateTo([subId]);
                ex.appendChild(card);
              });
              return;
            }
        
            // path = [subId] â†’ show services
            if (path.length === 1) {
              const sub = rootNode?.[path[0]];
              const services = sub?.services || {};
              Object.keys(services).sort().forEach(svc => {
                const card = document.createElement("div");
                card.className = "drill-card group";
                card.innerHTML = `<h4 style="margin:0">${svc}</h4>`;
                card.onclick = () => navigateTo([...path, svc]);
                ex.appendChild(card);
              });
              return;
            }
        
            // path = [subId, service] â†’ show resource types
            if (path.length === 2) {
              const sub = rootNode?.[path[0]];
              const service = sub?.services?.[path[1]] || {};
              Object.keys(service).sort().forEach(rtype => {
                const card = document.createElement("div");
                card.className = "drill-card group";
                card.innerHTML = `<h4 style="margin:0">${rtype}</h4>`;
                card.onclick = () => navigateTo([...path, rtype]);
                ex.appendChild(card);
              });
              return;
            }
        
            // path = [subId, service, resourceType] â†’ list resources
            if (path.length === 3) {
              const sub = rootNode?.[path[0]];
              const resources = sub?.services?.[path[1]]?.[path[2]] || [];
              resources.forEach(res => {
                const card = document.createElement("div");
                card.className = "drill-card leaf";
                card.innerHTML = `<h4 style="margin:0">${res.name}</h4><p class="meta" style="margin:4px 0 0 0">${res.type || ""}</p>`;
                card.onclick = () => {
                  navigateTo([...path, res.name]); // keeps breadcrumb consistent
                  showResourceDetails(res);
                };
                ex.appendChild(card);
              });
              return;
            }
        
            // path = [subId, service, resourceType, resourceName] â†’ already handled by showResourceDetails
            return;
          }
        
          // ---------- CLI providers (unchanged) ----------
          if (!node || isLeaf(node)) {
            const fullCmd = fullCmdFromPath(path);
            const header = document.createElement("div");
            header.style.margin = "6px 0 14px 0";
            header.innerHTML = `
              <div class="meta" style="font-size:14px;color:#111827;">
                <strong>${node?.command || fullCmd || "Command"}</strong>
              </div>
              <div class="meta" style="margin-top:4px;">${node?.help || ""}</div>`;
            ex.appendChild(header);
            if (currentProvider) await renderMatchedControls(ex, currentProvider.key, fullCmd);
            return;
          }
        
          const PRIORITY = new Map([["create",1],["delete",2],["list",3],["show",4],["update",5]]);
          const keys = Object.keys(node.subcommands).sort((a,b)=>{
            const pa = PRIORITY.get(a) ?? 999, pb = PRIORITY.get(b) ?? 999;
            return pa !== pb ? pa - pb : a.localeCompare(b);
          });
          keys.forEach(key=>{
            const sub = node.subcommands[key];
            const group = !isLeaf(sub);
            const card = document.createElement("div");
            card.className = `drill-card ${group ? "group" : "leaf"}`;
            const icon = iconMap[key] || (group ? "folder" : "terminal");
            card.innerHTML = `<h4 style="margin:0 0 6px 0;display:flex;align-items:center;gap:8px">
              <i data-lucide="${icon}"></i> ${key} ${group ? '<span class="meta">â€º</span>' : ""}
            </h4><p class="meta" style="margin:0">${sub.help || ""}</p>`;
            card.onclick = () => { navigateTo([...path, key]); if (window.lucide?.createIcons) lucide.createIcons(); };
            ex.appendChild(card);
          });
          if (window.lucide?.createIcons) lucide.createIcons();
        }
        
        async function renderMatchedControls(container,providerKey,fullCmd){
          await loadControlsMapping();
          const wrap=document.createElement("div"); wrap.id="matches-panel";
          const h=document.createElement("h3"); h.textContent="Matched Controls"; wrap.appendChild(h);
          const cmdKey=`${providerKey}:${fullCmd}`;
          const entry=commandToControls&&commandToControls[cmdKey];
          if(entry&&entry.matched_controls&&entry.matched_controls.length){
            const grid=document.createElement("div"); grid.className="controls-grid";
            entry.matched_controls.forEach(ctrl=>grid.appendChild(controlCard(ctrl)));
            wrap.appendChild(grid);
          } else {
            const p=document.createElement("p"); p.className="meta"; p.textContent="No mapped controls."; wrap.appendChild(p);
          }
          container.appendChild(wrap);
        }
      
        function showResourceDetails(res) {
          const details = document.getElementById("details");
          details.style.display = "block";
        
          document.getElementById("op-title").innerText = res.name || "Resource";
          document.getElementById("op-help").innerText = res.type || "";
        
          // ðŸ”¹ clear stale fields
          document.getElementById("form-container").innerHTML = "";
          document.getElementById("json-display").innerText = JSON.stringify(res, null, 2);
          const cli = document.getElementById("cli-display");
          cli.innerText = "No CLI for discovery";
          cli.dataset.cli = "";
        }
        
        function controlCard(ctrl){
          const card=document.createElement("div");
          card.className="control-card";
          const scorePct=(ctrl.match_score*100).toFixed(1);
          card.innerHTML=`
            <div class="control-card-inner">
              <div class="control-card-front">
                <div><strong>${ctrl.id.toUpperCase()}</strong></div>
                <div class="meta">${ctrl.title}</div>
                <div class="family">${ctrl.family || ""}</div>
              </div>
              <div class="control-card-back">
                <div><strong>${ctrl.id}</strong> â€“ ${ctrl.title}</div>
                <div><em>Family: ${ctrl.family || "N/A"}</em></div>
                <div style="margin-top:6px;"><strong>Description:</strong><br>${ctrl.description || "No description"}</div>
                <div style="margin-top:6px;"><strong>Score:</strong> ${isNaN(scorePct)? "N/A" : scorePct + "%"}</div>
              </div>
            </div>`;
          card.addEventListener("click",()=>card.classList.toggle("flipped"));
          return card;
        }
      
        /* ------------------------------ details panel --------------------------- */
        function resetDetailsPanel(){
          const details=document.getElementById("details"); details.style.display="none";
          document.getElementById("op-title").innerText="Operation";
          document.getElementById("op-help").innerText="";
          document.getElementById("form-container").innerHTML="";
          document.getElementById("json-display").innerText="No JSON loaded yet...";
          const cli=document.getElementById("cli-display"); cli.innerText="No CLI generated yet..."; cli.dataset.cli="";
        }
      
        function showDetails(node) {
          const details = document.getElementById("details");
          details.style.display = "block";
        
          const fullCmd = fullCmdFromPath(path);
          document.getElementById("op-title").innerText = node.command || fullCmd || "Operation";
          document.getElementById("op-help").innerText = node.help || "";
        
          // ðŸ”¹ clear everything each time
          const formContainerEl = document.getElementById("form-container");
          formContainerEl.innerHTML = "";
          document.getElementById("json-display").innerText = "{ }";
          const cli = document.getElementById("cli-display");
          cli.innerText = `${currentProvider?.bin || ""} ${fullCmd}`.trim();
          cli.dataset.cli = "";
        
          const opts = node.options || {};
          if (Object.keys(opts).length > 0) {
            for (const [opt, info] of Object.entries(opts)) {
              const f = document.createElement("div");
              f.className = "form-field";
              f.innerHTML = `
                <label>${opt} â€“ ${info.help || ""}</label>
                <input type="text" id="field-${opt}" placeholder="e.g. ${opt} value OR just ${opt}">
              `;
              formContainerEl.appendChild(f);
            }
            
            const btn = document.createElement("button");
            btn.textContent = "Generate JSON + CLI";
            btn.onclick = () => {
              const args = [];
              const payload = [];
            
              for (const [opt] of Object.entries(opts)) {
                const v = document.getElementById(`field-${opt}`).value.trim();
                if (v) {
                  args.push(v);        // take full string exactly as typed
                  payload.push(v);     // JSON becomes array of strings
                }
              }
            
              document.getElementById("json-display").innerText = JSON.stringify(payload, null, 2);
              let cmd = `${currentProvider.bin} ${fullCmd}`;
              if (args.length) cmd += " " + args.join(" ");
              cli.innerText = cmd;
              cli.dataset.cli = cmd;
            };
            formContainerEl.appendChild(btn);
          }
        }
        
        /* ------------------------------- actions -------------------------------- */
        function downloadProviderJSON(){
          if(!currentProvider||!currentTree) return showToast("No provider loaded yet.","warning");
          const blob=new Blob([JSON.stringify(currentTree,null,2)],{type:"application/json"});
          const a=document.createElement("a");a.href=URL.createObjectURL(blob);
          a.download=`${currentProvider.key||currentProvider.name}.json`;a.click();
        }
        function copyJSON(){navigator.clipboard.writeText(document.getElementById("json-display").innerText).then(()=>showToast("JSON copied!","success"));}
        function downloadJSON(){const text=document.getElementById("json-display").innerText;
          const blob=new Blob([text],{type:"application/json"});const a=document.createElement("a");
          a.href=URL.createObjectURL(blob);a.download="payload.json";a.click();}
        function copyCLI(){const cli=document.getElementById("cli-display");
          if(cli&&cli.dataset.cli&&cli.dataset.cli.trim()!==""){navigator.clipboard.writeText(cli.dataset.cli).then(()=>showToast("CLI command copied!","success"));}
          else{showToast("No CLI command generated yet.","warning");}}
      
        function showToast(message, type="info"){
          const c=document.getElementById("toast-container")||(()=>{const d=document.createElement("div");d.id="toast-container";document.body.appendChild(d);return d})();
          const t=document.createElement("div"); t.className=`toast ${type}`; t.textContent=message; c.appendChild(t); setTimeout(()=>t.remove(),4000);
        }
      
        /* --------------------------------- init --------------------------------- */
        document.addEventListener("DOMContentLoaded", async () => {
          await maybeAddAzureDiscovery();
          renderProviders();
          await loadControlsMapping();
          if (window.lucide?.createIcons) lucide.createIcons();
        
          const input = document.getElementById("search");
          const onType = debounce(async (e) => {
            const q = e.target.value.toLowerCase().trim();
            if (!q) {
              if (mode === "provider") renderProviders();
              else renderControlsNav();
              return;
            }
            if (mode === "provider") { await searchProviders(q); }
            else { searchControls(q); }
          }, 250);
          input?.addEventListener("input", onType);
        });


      </script>
  <div id="toast-container"></div>
</body>
</html>
